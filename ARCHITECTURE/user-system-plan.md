# üë• User System Plan

## üéØ –¶–µ–ª—å: –°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

–°–æ–∑–¥–∞—Ç—å –≥–∏–±–∫—É—é —Å–∏—Å—Ç–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—è–º–∏ **Admin** (–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø) –∏ **Editor** (—Ç–æ–ª—å–∫–æ –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤).

## üîç –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### **–ß—Ç–æ –µ—Å—Ç—å —Å–µ–π—á–∞—Å:**
```typescript
// NextAuth.js –±–∞–∑–æ–≤–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
// –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ "–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω/–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω"
// –ù–µ—Ç —Ä–æ–ª–µ–π, –Ω–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
```

### **–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –í—Å–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–º–µ—é—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
- ‚ùå –ù–µ—Ç —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- ‚ùå –ù–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- ‚ùå –ù–µ—Ç –∞—É–¥–∏—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üéØ –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π

### **–†–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:**

#### **üîë Admin (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)**
- ‚úÖ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏**: —Å–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ
- ‚úÖ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã**: —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –ª–∏–º–∏—Ç—ã, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã RAG
- ‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤**: –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ  
- ‚úÖ **–ü—Ä–æ—Å–º–æ—Ç—Ä –∞–Ω–∞–ª–∏—Ç–∏–∫–∏**: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –ª–æ–≥–∏, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- ‚úÖ **–°–∏—Å—Ç–µ–º–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**: backup, –º–∏–≥—Ä–∞—Ü–∏–∏, –æ—á–∏—Å—Ç–∫–∞

#### **üìù Editor (–†–µ–¥–∞–∫—Ç–æ—Ä)**
- ‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤**: –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
- ‚úÖ **–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö –∑–∞–≥—Ä—É–∑–æ–∫**: –∏—Å—Ç–æ—Ä–∏—è —Å–≤–æ–∏—Ö —Ñ–∞–π–ª–æ–≤
- ‚ùå **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã**: –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã
- ‚ùå **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏**: –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ
- ‚ùå **–°–∏—Å—Ç–µ–º–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞**: –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞

#### **üë§ User (–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) - –±—É–¥—É—â–µ–µ**
- ‚úÖ **–ß–∞—Ç**: –º–æ–∂–µ—Ç –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã RAG —Å–∏—Å—Ç–µ–º–µ
- ‚ùå **–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤**: –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞
- ‚ùå **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å**: –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞

## üìã –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### **Phase 1: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (1 –¥–µ–Ω—å)**

#### 1.1 –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–æ–ª—è–º–∏
```sql
-- –†–∞—Å—à–∏—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É users –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  
  -- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  email TEXT UNIQUE NOT NULL,
  username TEXT UNIQUE,
  password_hash TEXT,                    -- –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  
  -- –†–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞
  role TEXT NOT NULL DEFAULT 'editor',   -- 'admin', 'editor', 'user'
  status TEXT NOT NULL DEFAULT 'active', -- 'active', 'inactive', 'suspended'
  
  -- OAuth –¥–∞–Ω–Ω—ã–µ (NextAuth.js)
  provider TEXT,                         -- 'google', 'github', 'credentials'
  provider_id TEXT,                      -- ID –æ—Ç OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
  
  -- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ  
  first_name TEXT,
  last_name TEXT,
  avatar_url TEXT,
  
  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  last_login_at DATETIME,
  
  -- –ê—É–¥–∏—Ç
  created_by INTEGER REFERENCES users(id), -- –ö—Ç–æ —Å–æ–∑–¥–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  updated_by INTEGER REFERENCES users(id)  -- –ö—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –æ–±–Ω–æ–≤–ª—è–ª
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_status ON users(status);
CREATE UNIQUE INDEX idx_users_provider ON users(provider, provider_id);
```

#### 1.2 –¢–∞–±–ª–∏—Ü–∞ —Å–µ—Å—Å–∏–π –∏ –∞—É–¥–∏—Ç–∞
```sql
-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞
CREATE TABLE user_sessions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  session_token TEXT UNIQUE NOT NULL,
  ip_address TEXT,
  user_agent TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  expires_at DATETIME NOT NULL,
  last_activity_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- –ê—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE user_actions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
  action_type TEXT NOT NULL,             -- 'file_upload', 'settings_change', 'user_create', etc.
  resource_type TEXT,                    -- 'file', 'user', 'settings'
  resource_id TEXT,                      -- ID —Ä–µ—Å—É—Ä—Å–∞  
  action_details TEXT,                   -- JSON —Å –¥–µ—Ç–∞–ª—è–º–∏ –¥–µ–π—Å—Ç–≤–∏—è
  ip_address TEXT,
  user_agent TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_user_actions_user ON user_actions(user_id);
CREATE INDEX idx_user_actions_type ON user_actions(action_type);
CREATE INDEX idx_user_actions_date ON user_actions(created_at);
```

#### 1.3 –¢–∞–±–ª–∏—Ü–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (–¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)
```sql
-- –ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
CREATE TABLE permissions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT UNIQUE NOT NULL,             -- 'files.upload', 'users.create', 'settings.edit'
  description TEXT,
  resource TEXT,                         -- 'files', 'users', 'settings'
  action TEXT                            -- 'create', 'read', 'update', 'delete'
);

-- –°–≤—è–∑—å —Ä–æ–ª–µ–π —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏
CREATE TABLE role_permissions (
  role TEXT NOT NULL,                    -- 'admin', 'editor', 'user'
  permission_id INTEGER REFERENCES permissions(id) ON DELETE CASCADE,
  PRIMARY KEY (role, permission_id)
);

-- –ë–∞–∑–æ–≤—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
INSERT INTO permissions (name, description, resource, action) VALUES
('files.upload', 'Upload files to knowledge base', 'files', 'create'),
('files.view', 'View uploaded files', 'files', 'read'),
('files.delete', 'Delete files from knowledge base', 'files', 'delete'),
('users.create', 'Create new users', 'users', 'create'),
('users.manage', 'Manage existing users', 'users', 'update'),
('users.delete', 'Delete users', 'users', 'delete'),
('settings.view', 'View system settings', 'settings', 'read'),
('settings.edit', 'Edit system settings', 'settings', 'update'),
('analytics.view', 'View system analytics', 'analytics', 'read');

-- –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è Admin
INSERT INTO role_permissions (role, permission_id) VALUES
('admin', 1), ('admin', 2), ('admin', 3), ('admin', 4), ('admin', 5), 
('admin', 6), ('admin', 7), ('admin', 8), ('admin', 9);

-- –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è Editor  
INSERT INTO role_permissions (role, permission_id) VALUES
('editor', 1), ('editor', 2);
```

### **Phase 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ NextAuth.js –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (1-2 –¥–Ω—è)**

#### 2.1 –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è NextAuth
```typescript
// src/lib/auth.ts
import NextAuth, { DefaultSession } from "next-auth"
import { JWT } from "next-auth/jwt"
import CredentialsProvider from "next-auth/providers/credentials"
import GoogleProvider from "next-auth/providers/google"
import { getUserByEmail, createUser, updateUserLastLogin } from "./user-service"

// –†–∞—Å—à–∏—Ä—è–µ–º —Ç–∏–ø—ã NextAuth
declare module "next-auth" {
  interface Session extends DefaultSession {
    user: {
      id: string
      role: string
      status: string
      permissions: string[]
    } & DefaultSession["user"]
  }
}

declare module "next-auth/jwt" {
  interface JWT {
    id: string
    role: string
    status: string
    permissions: string[]
  }
}

export const { handlers, auth, signIn, signOut } = NextAuth({
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
    CredentialsProvider({
      name: "credentials",
      credentials: {
        email: { label: "Email", type: "email" },
        password: { label: "Password", type: "password" }
      },
      async authorize(credentials) {
        if (!credentials?.email || !credentials?.password) return null
        
        const user = await authenticateUser(
          credentials.email as string, 
          credentials.password as string
        )
        
        return user
      }
    })
  ],
  
  callbacks: {
    async signIn({ user, account, profile }) {
      if (account?.provider === "google") {
        // –ü—Ä–∏ –≤—Ö–æ–¥–µ —á–µ—Ä–µ–∑ Google —Å–æ–∑–¥–∞–µ–º –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let dbUser = await getUserByEmail(user.email!)
        
        if (!dbUser) {
          // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–æ–ª—å—é editor –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          dbUser = await createUser({
            email: user.email!,
            username: user.name,
            first_name: profile?.given_name,
            last_name: profile?.family_name,
            avatar_url: user.image,
            provider: 'google',
            provider_id: account.providerAccountId,
            role: 'editor' // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã
          })
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (dbUser.status !== 'active') {
          return false // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏
        }
        
        return true
      }
      
      return true
    },
    
    async jwt({ token, user, account }) {
      if (user) {
        const dbUser = await getUserByEmail(user.email!)
        if (dbUser) {
          token.id = dbUser.id.toString()
          token.role = dbUser.role
          token.status = dbUser.status
          token.permissions = await getUserPermissions(dbUser.role)
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞
          await updateUserLastLogin(dbUser.id)
        }
      }
      
      return token
    },
    
    async session({ session, token }) {
      session.user.id = token.id
      session.user.role = token.role
      session.user.status = token.status
      session.user.permissions = token.permissions
      
      return session
    }
  },
  
  pages: {
    signIn: '/admin/login',
    error: '/admin/auth/error',
  }
})

// –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
async function getUserPermissions(role: string): Promise<string[]> {
  const db = await database
  const permissions = await db.all(`
    SELECT p.name 
    FROM permissions p
    JOIN role_permissions rp ON p.id = rp.permission_id
    WHERE rp.role = ?
  `, [role])
  
  return permissions.map(p => p.name)
}
```

#### 2.2 –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
```typescript
// src/lib/user-service.ts
import bcrypt from 'bcryptjs'
import { database } from './database'

export interface CreateUserData {
  email: string
  username?: string
  password?: string
  first_name?: string
  last_name?: string
  avatar_url?: string
  provider?: string
  provider_id?: string
  role?: string
  created_by?: number
}

export async function createUser(data: CreateUserData) {
  const db = await database
  
  const passwordHash = data.password 
    ? await bcrypt.hash(data.password, 12)
    : null
  
  const result = await db.run(`
    INSERT INTO users (
      email, username, password_hash, first_name, last_name, 
      avatar_url, provider, provider_id, role, created_by
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
  `, [
    data.email,
    data.username,
    passwordHash,
    data.first_name,
    data.last_name,
    data.avatar_url,
    data.provider,
    data.provider_id,
    data.role || 'editor',
    data.created_by
  ])
  
  const user = await getUserById(result.lastID as number)
  
  // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  await logUserAction(data.created_by || null, 'user_create', 'user', user.id.toString(), {
    email: data.email,
    role: data.role || 'editor'
  })
  
  return user
}

export async function getUserByEmail(email: string) {
  const db = await database
  return await db.get('SELECT * FROM users WHERE email = ? AND status = "active"', [email])
}

export async function getUserById(id: number) {
  const db = await database
  return await db.get('SELECT * FROM users WHERE id = ?', [id])
}

export async function updateUserRole(userId: number, newRole: string, updatedBy: number) {
  const db = await database
  
  await db.run(`
    UPDATE users 
    SET role = ?, updated_by = ?, updated_at = CURRENT_TIMESTAMP 
    WHERE id = ?
  `, [newRole, updatedBy, userId])
  
  await logUserAction(updatedBy, 'role_change', 'user', userId.toString(), {
    new_role: newRole
  })
}

export async function authenticateUser(email: string, password: string) {
  const user = await getUserByEmail(email)
  if (!user || !user.password_hash) return null
  
  const isValid = await bcrypt.compare(password, user.password_hash)
  if (!isValid) return null
  
  return {
    id: user.id.toString(),
    email: user.email,
    name: `${user.first_name} ${user.last_name}`.trim() || user.username,
    image: user.avatar_url
  }
}

export async function logUserAction(
  userId: number | null, 
  actionType: string, 
  resourceType: string, 
  resourceId: string, 
  details: any,
  req?: Request
) {
  const db = await database
  
  await db.run(`
    INSERT INTO user_actions (
      user_id, action_type, resource_type, resource_id, 
      action_details, ip_address, user_agent
    ) VALUES (?, ?, ?, ?, ?, ?, ?)
  `, [
    userId,
    actionType, 
    resourceType,
    resourceId,
    JSON.stringify(details),
    req?.headers.get('x-forwarded-for') || 'unknown',
    req?.headers.get('user-agent') || 'unknown'
  ])
}
```

### **Phase 3: Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ (1 –¥–µ–Ω—å)**

#### 3.1 Middleware –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
```typescript
// src/middleware.ts
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'
import { auth } from '@/lib/auth'

// –ú–∞—Ä—à—Ä—É—Ç—ã –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
const PROTECTED_ROUTES = {
  '/admin': ['settings.view'],
  '/admin/users': ['users.manage'],
  '/admin/settings': ['settings.edit'],
  '/admin/upload': ['files.upload'],
  '/admin/analytics': ['analytics.view'],
}

export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—â–∏—â–µ–Ω –ª–∏ –º–∞—Ä—à—Ä—É—Ç
  const requiredPermission = getRequiredPermission(pathname)
  if (!requiredPermission) {
    return NextResponse.next()
  }
  
  // –ü–æ–ª—É—á–∞–µ–º —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const session = await auth()
  
  if (!session?.user) {
    return NextResponse.redirect(new URL('/admin/login', request.url))
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
  const hasPermission = session.user.permissions?.includes(requiredPermission)
  if (!hasPermission) {
    return NextResponse.redirect(new URL('/admin/access-denied', request.url))
  }
  
  return NextResponse.next()
}

function getRequiredPermission(pathname: string): string | null {
  for (const [route, permissions] of Object.entries(PROTECTED_ROUTES)) {
    if (pathname.startsWith(route)) {
      return permissions[0] // –ë–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
    }
  }
  return null
}

export const config = {
  matcher: ['/admin/:path*']
}
```

#### 3.2 Hook –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
```typescript
// src/hooks/usePermissions.ts
import { useSession } from 'next-auth/react'

export function usePermissions() {
  const { data: session } = useSession()
  
  const hasPermission = (permission: string): boolean => {
    return session?.user?.permissions?.includes(permission) ?? false
  }
  
  const hasRole = (role: string): boolean => {
    return session?.user?.role === role
  }
  
  const isAdmin = (): boolean => hasRole('admin')
  const isEditor = (): boolean => hasRole('editor')
  
  return {
    hasPermission,
    hasRole,
    isAdmin,
    isEditor,
    permissions: session?.user?.permissions ?? [],
    role: session?.user?.role
  }
}
```

### **Phase 4: UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (2-3 –¥–Ω—è)**

#### 4.1 –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
```typescript
// src/app/admin/users/page.tsx
import { auth } from '@/lib/auth'
import { getAllUsers } from '@/lib/user-service'
import { UserManagementTable } from '@/components/admin/UserManagementTable'
import { CreateUserButton } from '@/components/admin/CreateUserButton'

export default async function UsersPage() {
  const session = await auth()
  
  if (session?.user?.role !== 'admin') {
    return <div>Access Denied</div>
  }
  
  const users = await getAllUsers()
  
  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold">User Management</h1>
        <CreateUserButton />
      </div>
      
      <UserManagementTable users={users} currentUser={session.user} />
    </div>
  )
}
```

#### 4.2 –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```typescript
// src/components/admin/UserManagementTable.tsx
'use client'

import { useState } from 'react'
import { usePermissions } from '@/hooks/usePermissions'

interface User {
  id: number
  email: string
  role: string
  status: string
  created_at: string
  last_login_at?: string
}

export function UserManagementTable({ users, currentUser }) {
  const { hasPermission } = usePermissions()
  const [selectedUsers, setSelectedUsers] = useState<number[]>([])
  
  const canManageUsers = hasPermission('users.manage')
  const canDeleteUsers = hasPermission('users.delete')
  
  return (
    <div className="bg-white shadow rounded-lg">
      <table className="min-w-full divide-y divide-gray-200">
        <thead className="bg-gray-50">
          <tr>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
              User
            </th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
              Role
            </th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
              Status
            </th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
              Last Login
            </th>
            {canManageUsers && (
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                Actions
              </th>
            )}
          </tr>
        </thead>
        <tbody className="bg-white divide-y divide-gray-200">
          {users.map((user) => (
            <UserRow 
              key={user.id} 
              user={user} 
              canEdit={canManageUsers && user.id !== currentUser.id}
              canDelete={canDeleteUsers && user.id !== currentUser.id}
            />
          ))}
        </tbody>
      </table>
    </div>
  )
}
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- üîê **–†–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞** –ø–æ —Ä–æ–ª—è–º
- üõ°Ô∏è **–ó–∞—â–∏—Ç–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π** —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
- üìù **–ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç** –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- üö´ **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

### **–£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å:**
- üë• **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- üé≠ **–ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π** –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π  
- üìä **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚ö° **–ë—ã—Å—Ç—Ä–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ** –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

### **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:**
- üîÑ **–õ–µ–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ** –Ω–æ–≤—ã—Ö —Ä–æ–ª–µ–π
- üéØ **–¢–æ—á–µ—á–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è** –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á
- üåê **OAuth –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** —Å –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
- üîß **API –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏** —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –†–æ–ª–∏ Admin –∏ Editor —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] Middleware –±–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø
- [ ] UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
- [ ] –ê—É–¥–∏—Ç –ª–æ–≥–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
- [ ] NextAuth.js –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π —Ä–æ–ª–µ–π
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞

---
*–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –æ—Å–Ω–æ–≤–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø—Ä–æ–¥–∞–∫—à–Ω-—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è.*